<tool id="ipo4xcmsSet" name="IPO for xcmsSet" version="0.0.3">
    
    <description>IPO optimization process for xcms.xcmsSet</description>
    
    <macros>
        <import>macros.xml</import>
    </macros>

    <expand macro="requirements"/>
    <expand macro="stdio"/>
    
    <command><![CDATA[
        @COMMAND_SCRIPT@

        #if $inputs.input == "zip_file":
            zipfile $inputs.zip_file
        #elif $inputs.input == "single_file":
            singlefile_galaxyPath $inputs.single_file singlefile_sampleName $inputs.single_file.name
        #end if

        parametersOutput $parametersOutput

        samplebyclass $samplebyclass

        ## profmethod $profmethod 
        nSlaves \${GALAXY_SLOTS:-1} method $methods.method 
        #if $methods.method == "centWave":
            ppm "c($methods.ppm)"
            min_peakwidth "c($methods.min_peakwidth)"
            max_peakwidth "c($methods.max_peakwidth)"
            #if $methods.options_c.option == "show":
                mzdiff "c($methods.options_c.mzdiff)"
                snthresh "c($methods.options_c.snthresh)"
                integrate "c($methods.options_c.integrate)"
                noise "c($methods.options_c.noise)"
                prefilter "c($methods.options_c.prefilter)"
                prefilter_value "c($methods.options_c.prefilter_value)"
            #end if
        #elif $methods.method == "matchedFilter":
            step "c($methods.step)"
            fwhm "c($methods.fwhm)"
            #if $methods.options_m.option == "show":
                sigma "c($methods.options_m.sigma)"
                max "c($methods.options_m.max)"
                snthresh "c($methods.options_m.snthresh)"
                mzdiff "c($methods.options_m.mzdiff)"
                steps "c($methods.options_m.steps)"
            #end if
        #end if

        @COMMAND_LOG_EXIT@ 2> /tmp/log.err
    ]]></command>
    
    <inputs>

        <conditional name="inputs">
            <param name="input" type="select" label="Choose your inputs method" >
                <option value="zip_file" selected="true">Zip file from your history containing your chromatograms</option>
                <option value="single_file">mzXML file from your history</option>
            </param>
            <when value="zip_file">
                <param name="zip_file" type="data" format="no_unzip.zip,zip" label="Zip file" />
            </when>
            <when value="single_file">
                <param name="single_file" type="data" format="mzxml" label="Single file" />
            </when>
        </conditional>
        
        <param name="samplebyclass" type="integer" value="2" label="Number of samples used per class to estimate the best parameters" help="Set to 0 to use the whole dataset. To save time, reduce this number" />

        <conditional name="methods">
            <param name="method" type="select" label="Extraction method for peaks detection" help="[method] See the help section below">
                <option value="centWave" >centWave</option>
                <option value="matchedFilter" selected="true">matchedFilter</option>
            </param>

            <!-- centWave Filter options -->
            <when value="centWave">
                <param name="ppm" type="text" value="17,32" label="Range for Max tolerated ppm m/z deviation in consecutive scans in ppm" optional="false" help="[ppm] (ex: 25 or 17,32)" />
                <param name="min_peakwidth" type="text" value="15,25" label="Range for Min peak width range in seconds" optional="true" help="[min_peakwidth] (ex: 20 or 12,18)" />
                <param name="max_peakwidth" type="text" value="45,55" label="Range for Max peak width range in seconds" optional="true" help="[max_peakwidth] (ex: 50 or 35,65)" />
                <conditional name="options_c">
                    <param name="option" type="select" label="Advanced options" >
                        <option value="show">show</option>
                        <option value="hide" selected="true">hide</option>
                    </param>
                    <when value="show">
                        <param name="snthresh" type="text" value="10" label="Range for Signal/Noise threshold" help="[snthresh] Signal to noise ratio cutoff (ex: 10 or 5,15)" />
                        <param name="mzdiff" type="text" value="-0.001" label="Range for Min m/z difference" help="[mzdiff] Min m/z difference for peaks with overlapping RT (ex: -0.001 or -0.001,0.010)" />
                        <param name="integrate" type="select" label="Peak limits method" help="[integrate]" multiple="true" >
                            <option value="1">1 - peak limits based on smoothed 2nd derivative (less precise)</option>
                            <option value="2">2 - peak limits based on real data (more sensitive to noise)</option>
                        </param>
                        <param name="prefilter" type="text" value="3" label="Range for the k value for the Prefilter step for the first phase" help="[prefilter] Mass traces are only retained if they contain at least ‘k’ peaks with intensity >= ‘I’ (ex: 3 or 2,3)"/>
                        <param name="prefilter_value" type="text" value="100" label="Range for the I value for the Prefilter step for the first phase" help="[prefilter_value] Mass traces are only retained if they contain at least ‘k’ peaks with intensity >= ‘I’ (ex: 100 or 95,105)"/>
                        <param name="noise" type="text" value="0" label="Range for the Noise filter" help="[noise] optional argument which is useful for data that was centroided without any intensity threshold, centroids with intensity smaller than ‘noise’ are omitted from ROI detection (ex: 0 or 0,0.1)"/>
                    </when>
                    <when value="hide" />
                </conditional>
            </when>

            <!-- matched Filter options -->
            <when value="matchedFilter">
                <param name="step" type="text" value="0.1" label="Range for Step size to use for profile generation" optional="true" help="[step] The peak detection algorithm creates extracted ion base peak chromatograms (EIBPC) on a fixed step size (ex: 0 or 0.05,0.15)" />
                <param name="fwhm" type="text" value="25,35" label="Range for Full width at half maximum of matched filtration gaussian model peak" optional="true" help="[fwhm] Only used to calculate the actual sigma (ex: 30 or 25,35)" />
                <conditional name="options_m">
                    <param name="option" type="select" label="Advanced options" >
                        <option value="show">show</option>
                        <option value="hide" selected="true">hide</option>
                    </param>
                    <when value="show">
                        <param name="sigma" type="text" value="0" label="sigma" help="Range for standard deviation (fwhm/2.3548) (ex: 0 or 0,1)" />
                        <param name="max" type="text" value="5" label="Range for Maximum number of peaks per extracted ion chromatogram" help="[max] (ex: 5 or 4,6)" />
                        <param name="snthresh" type="text" value="10" label="Range for Signal to noise ratio cutoff" help="[snthresh] (ex: 10 or 3,17)" />
                        <param name="steps" type="text" value="2" label="Range for Number of steps to merge prior to filtration" help="[steps] The peak identification algorithm combines a given number of EIBPCs prior to filtration and peak detection, as defined by the steps argument (ex: 2 or 1,3)" />
                        <param name="mzdiff" type="text" value="0" label="m/z difference" help="Range for min m/z difference for peaks with overlapping RT (0.8-step*steps) (ex: 2 or 1,3)" />
                    </when>
                    <when value="hide" />
                </conditional>
            </when>
        </conditional>       


    </inputs>
    
    <outputs>
        <data name="parametersOutput" format="tabular" label="IPO_parameters4xcmsSet.tsv" />
        <data name="log" format="txt" label="ipo4xcmsSet.log.txt" />
    </outputs>
    
    <tests>
        <test>
            <param name="inputs|input" value="single_file" />
            <param name="inputs|single_file" value="MM14.mzML"  ftype="mzxml" />
            <param name="samplebyclass" value="0" />
            <param name="methods|method" value="centWave" />
            <param name="methods|ppm" value="56" />
            <param name="methods|min_peakwidth" value="3,9.5" />
            <param name="methods|max_peakwidth" value="10,20" />
            <output name="parametersOutput" file="MM14_IPO_parameters4xcmsSet.tsv" />
        </test>
        <!-- Too long for Travis CI -->
        <!--<test>
            <param name="inputs|input" value="zip_file" />
            <param name="inputs|zip_file" value="sacuri_2files.zip"  ftype="zip" />
            <param name="samplebyclass" value="1" />
            <param name="methods|method" value="centWave" />
            <param name="methods|ppm" value="25" />
            <param name="methods|min_peakwidth" value="20,30" />
            <param name="methods|max_peakwidth" value="45,55" />
            <output name="parametersOutput" file="sacuri_2files_centWave_IPO_parameters4xcmsSet.tsv" />
        </test>-->
        <!-- Too long for Travis CI -->
        <!--<test>
            <param name="inputs|input" value="zip_file" />
            <param name="inputs|zip_file" value="sacuri_2files.zip"  ftype="zip" />
            <param name="samplebyclass" value="1" />
            <param name="methods|method" value="matchedFilter" />
            <param name="methods|step" value="0.05,0.15" />
            <param name="methods|fwhm" value="25,35" />
            <output name="parametersOutput" file="sacuri_2files_matchedFilter_IPO_parameters4xcmsSet.tsv" />
        </test>-->
        <!--Failed:
                Error in resultIncreased(history) : 
                        No isotopes have been detected, peak picking not optimizable by IPO!-->
        <!--<test>
            <param name="inputs|input" value="zip_file" />
            <param name="inputs|zip_file" value="faahKO_reduce.zip"  ftype="zip" />
            <param name="methods|method" value="centWave" />
            <param name="methods|ppm" value="25" />
            <param name="methods|min_peakwidth" value="15,25" />
            <param name="methods|min_peakwidth" value="20,30" />
            <param name="methods|max_peakwidth" value="45,55" />
            <output name="parametersOutput" file="faahKO_IPO_parameters4xcmsSet.tsv" />
        </test>-->
    </tests>
    
    <help><![CDATA[

@HELP_AUTHORS@

===============
IPO.ipo4xcmsSet
===============

-----------
Description
-----------

A Tool for automated Optimization of XCMS Parameters


-----------------
Workflow position
-----------------

**Upstream tools**

========================= ================= ======= =========
Name                      output file       format  parameter
========================= ================= ======= =========
NA                        NA                zip     NA       
========================= ================= ======= =========


**Downstream tools**

+---------------------------+----------------------+-----------------+
| Name                      | Output file          | Format          |
+===========================+======================+=================+
|xcms.xcmsSet               | parametersOutput.tsv | Tabular         |
+---------------------------+--------------------+-------------------+



-----------
Input files
-----------

+---------------------------+------------+
| Parameter : num + label   |   Format   |
+===========================+============+
| 1 : Choose your inputs    |   zip      |
+---------------------------+------------+

**Choose your inputs**

You have two methods for your inputs:

    | Zip file (recommended): You can put a zip file containing your inputs: myinputs.zip (containing all your conditions as sub-directories).
    | library folder: You must specify the name of your "library" (folder) created within your space project (for example: /projet/externe/institut/login/galaxylibrary/yourlibrary). Your library must contain all your conditions as sub-directories.

Steps for creating the zip file
-------------------------------

**Step1: Creating your directory and hierarchize the subdirectories**


VERY IMPORTANT: If you zip your files under Windows, you must use the 7Zip software (http://www.7-zip.org/), otherwise your zip will not be well unzipped on the platform W4M (zip corrupted bug).

Your zip should contain all your conditions as sub-directories. For example, two conditions (mutant and wild):
arabidopsis/wild/01.raw
arabidopsis/mutant/01.raw

**Step2: Creating a zip file**

Create your zip file (e.g.: arabidopsis.zip).

**Step 3 : Uploading it to our Galaxy server**

If your zip file is less than 2Gb, you get use the Get Data tool to upload it.

Otherwise if your zip file is larger than 2Gb, please refer to the HOWTO on workflow4metabolomics.org (http://application.sb-roscoff.fr/download/w4m/howto/galaxy_upload_up_2Go.pdf).

For more informations, don't hesitate to send us an email at supportATworkflow4metabolomics.org).

Advices for converting your files for the XCMS input
----------------------------------------------------

We recommend you to convert your raw files to **mzXML** in centroid mode (smaller files) and the files will be compatible with the xmcs centWave method.

**We recommend you the following parameters:**

Use Filtering: **True**

Use Peak Picking: **True**

Peak Peaking -Apply to MS Levels: **All Levels (1-)** : Centroid Mode

Use zlib: **64**

Binary Encoding: **64**

m/z Encoding: **64**

Intensity Encoding: **64**


----------
Parameters
----------

Extraction method for peaks detection
-------------------------------------

**Matched Filter**

    | One parameter to consider is the Gaussian model peak width used for matched filtration,an integral part of the peak detection algorithm. 
    | For a discussion of how model peak width affects the signal to noise ratio, see Danielsson et al. (2002).


**cent Wave**

    | This algorithm is most suitable for high resolution LC/{TOF,OrbiTrap,FTICR}-MS data in centroid mode.
    | Due to the fact that peak centroids are used, a binning step is not necessary.
    | The method is capable of detecting close-by-peaks and also overlapping peaks. Some efforts are made to detect the exact peak boundaries to get precise peak integrals.


------------
Output files
------------

IPO_parameters4xcmsSet.tsv

    | Optimal parameters for xcmsSet


---------------------------------------------------

Changelog/News
--------------



    ]]></help>

    <expand macro="citation" />
</tool>
